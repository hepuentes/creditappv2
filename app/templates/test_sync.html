<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Sincronización - CreditApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Prueba de Sincronización Offline</h1>
        
        <!-- Sección de Login -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>1. Autenticación API</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="email" id="email" class="form-control mb-2" placeholder="Email" value="admin@creditapp.com">
                        <input type="password" id="password" class="form-control mb-2" placeholder="Contraseña" value="admin123">
                        <input type="text" id="deviceName" class="form-control mb-2" placeholder="Nombre del dispositivo" value="Navegador de Prueba">
                        <button onclick="loginAPI()" class="btn btn-primary">Conectar</button>
                    </div>
                    <div class="col-md-6">
                        <div id="loginResult" class="alert" style="display:none;"></div>
                        <div id="tokenInfo" style="display:none;">
                            <strong>Token:</strong> <span id="tokenValue"></span><br>
                            <strong>Usuario:</strong> <span id="userInfo"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Sincronización -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>2. Descargar Datos (Sync Pull)</h3>
            </div>
            <div class="card-body">
                <button onclick="syncPull()" class="btn btn-success me-2">Descargar Clientes</button>
                <button onclick="syncPullProductos()" class="btn btn-success me-2">Descargar Productos</button>
                <button onclick="syncPullVentas()" class="btn btn-success">Descargar Ventas</button>
                <div id="syncResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Sección de Envío -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>3. Enviar Cambios (Sync Push)</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label>Simular cambio en cliente:</label>
                    <input type="text" id="clienteNombre" class="form-control mb-2" placeholder="Nombre del cliente" value="Cliente de Prueba">
                    <input type="text" id="clienteCedula" class="form-control mb-2" placeholder="Cédula" value="12345678">
                    <button onclick="simularCambioCliente()" class="btn btn-warning">Simular Nuevo Cliente</button>
                </div>
                <div id="pushResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Log de Actividad -->
        <div class="card">
            <div class="card-header">
                <h3>Log de Actividad</h3>
                <button onclick="clearLog()" class="btn btn-sm btn-secondary">Limpiar</button>
            </div>
            <div class="card-body">
                <pre id="activityLog" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></pre>
            </div>
        </div>
    </div>

    <script>
        let authToken = '';
        let baseURL = window.location.origin + '/api/v1';

        function log(message) {
            const logElement = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('activityLog').textContent = '';
        }

        async function loginAPI() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const deviceName = document.getElementById('deviceName').value;

            try {
                log('Intentando autenticación...');
                const response = await fetch(`${baseURL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        device_name: deviceName,
                        device_uuid: 'test-browser-' + Date.now()
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch (error) {
                    log(`✗ Error al procesar respuesta: ${error.message}`);
                    throw new Error(`Error al procesar respuesta: ${error.message}`);
                }

                const resultDiv = document.getElementById('loginResult');
                
                if (data.success) {
                    authToken = data.token;
                    resultDiv.className = 'alert alert-success';
                    resultDiv.textContent = 'Autenticación exitosa';
                    resultDiv.style.display = 'block';
                    
                    document.getElementById('tokenValue').textContent = data.token.substring(0, 20) + '...';
                    document.getElementById('userInfo').textContent = `${data.usuario.nombre} (${data.usuario.rol})`;
                    document.getElementById('tokenInfo').style.display = 'block';
                    
                    log(`✓ Autenticación exitosa para ${data.usuario.nombre}`);
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.textContent = 'Error: ' + (data.error || 'Error desconocido');
                    resultDiv.style.display = 'block';
                    log(`✗ Error de autenticación: ${data.error}`);
                }
            } catch (error) {
                log(`✗ Error de conexión: ${error.message}`);
                const resultDiv = document.getElementById('loginResult');
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = 'Error de conexión: ' + error.message;
                resultDiv.style.display = 'block';
            }
        }

        async function syncPull() {
            if (!authToken) {
                alert('Primero debes autenticarte');
                return;
            }

            try {
                log('Descargando clientes...');
                const response = await fetch(`${baseURL}/sync/clientes`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                let data;
                try {
                    data = await response.json();
                } catch (error) {
                    log(`✗ Error al procesar respuesta: ${response.status} ${response.statusText}`);
                    throw new Error(`Error en la respuesta del servidor: ${response.status} ${response.statusText}`);
                }

                const resultDiv = document.getElementById('syncResult');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Clientes descargados:</strong> ${data.count}<br>
                            <details>
                                <summary>Ver datos (primeros 5)</summary>
                                <pre>${JSON.stringify(data.data.slice(0, 5), null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    log(`✓ Descargados ${data.count} clientes`);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || response.statusText}</div>`;
                    log(`✗ Error descargando clientes: ${data.error || response.statusText}`);
                }
            } catch (error) {
                const resultDiv = document.getElementById('syncResult');
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                log(`✗ Error de conexión: ${error.message}`);
            }
        }

        async function syncPullProductos() {
            if (!authToken) {
                alert('Primero debes autenticarte');
                return;
            }

            try {
                log('Descargando productos...');
                const response = await fetch(`${baseURL}/sync/productos`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                let data;
                try {
                    data = await response.json();
                } catch (error) {
                    log(`✗ Error al procesar respuesta: ${response.status} ${response.statusText}`);
                    throw new Error(`Error en la respuesta del servidor: ${response.status} ${response.statusText}`);
                }
                
                const resultDiv = document.getElementById('syncResult');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Productos descargados:</strong> ${data.count}<br>
                            <details>
                                <summary>Ver datos (primeros 5)</summary>
                                <pre>${JSON.stringify(data.data.slice(0, 5), null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    log(`✓ Descargados ${data.count} productos`);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || response.statusText}</div>`;
                    log(`✗ Error descargando productos: ${data.error || response.statusText}`);
                }
            } catch (error) {
                const resultDiv = document.getElementById('syncResult');
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                log(`✗ Error de conexión: ${error.message}`);
            }
        }

        async function syncPullVentas() {
            if (!authToken) {
                alert('Primero debes autenticarte');
                return;
            }

            try {
                log('Descargando ventas...');
                const response = await fetch(`${baseURL}/sync/ventas`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                let data;
                try {
                    data = await response.json();
                } catch (error) {
                    log(`✗ Error al procesar respuesta: ${response.status} ${response.statusText}`);
                    throw new Error(`Error en la respuesta del servidor: ${response.status} ${response.statusText}`);
                }
                
                const resultDiv = document.getElementById('syncResult');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Ventas descargadas:</strong> ${data.count}<br>
                            <details>
                                <summary>Ver datos (primeros 3)</summary>
                                <pre>${JSON.stringify(data.data.slice(0, 3), null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    log(`✓ Descargadas ${data.count} ventas`);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || response.statusText}</div>`;
                    log(`✗ Error descargando ventas: ${data.error || response.statusText}`);
                }
            } catch (error) {
                const resultDiv = document.getElementById('syncResult');
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                log(`✗ Error de conexión: ${error.message}`);
            }
        }

        async function simularCambioCliente() {
            if (!authToken) {
                alert('Primero debes autenticarte');
                return;
            }

            const nombre = document.getElementById('clienteNombre').value;
            const cedula = document.getElementById('clienteCedula').value;

            if (!nombre || !cedula) {
                alert('Ingrese nombre y cédula del cliente');
                return;
            }

            try {
                log(`Simulando creación de cliente: ${nombre} (${cedula})...`);
                
                const clienteData = {
                    nombre: nombre,
                    cedula: cedula,
                    telefono: "3001234567",
                    email: "",
                    direccion: "Dirección de prueba",
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(`${baseURL}/sync/push`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        changes: [
                            {
                                uuid: 'test-' + Date.now(),
                                tabla: 'clientes',
                                registro_uuid: 'client-' + Date.now(),
                                operacion: 'INSERT',
                                datos: clienteData,
                                timestamp: new Date().toISOString(),
                                version: 1
                            }
                        ],
                        device_timestamp: new Date().toISOString()
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch (error) {
                    log(`✗ Error al procesar respuesta: ${response.status} ${response.statusText}`);
                    throw new Error(`Error en la respuesta del servidor: ${response.status} ${response.statusText}`);
                }

                const pushDiv = document.getElementById('pushResult');
                
                if (data.success) {
                    pushDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Simulación enviada correctamente</strong><br>
                            <p>Se ha simulado el envío de un nuevo cliente desde el dispositivo.</p>
                            <details>
                                <summary>Ver respuesta</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    log(`✓ Simulación de cliente enviada correctamente`);
                } else {
                    pushDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Error desconocido'}</div>`;
                    log(`✗ Error en simulación: ${data.error || 'Error desconocido'}`);
                }
            } catch (error) {
                const pushDiv = document.getElementById('pushResult');
                pushDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                log(`✗ Error de conexión: ${error.message}`);
            }
        }

        // Inicialización
        log('Página de pruebas cargada. Lista para probar sincronización.');
    </script>
</body>
</html>
